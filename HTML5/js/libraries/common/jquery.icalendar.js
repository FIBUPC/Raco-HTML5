(function(e){function r(){this._defaults={sites:[],icons:"icalendar.png",iconSize:16,target:"_blank",compact:false,popup:false,popupText:"Send to my calendar...",tipPrefix:"",echoUrl:"",echoField:"",start:null,end:null,title:"",summary:"",description:"",location:"",url:"",contact:"",recurrence:null,copyConfirm:"The event will be copied to your clipboard. Continue?",copySucceeded:"The event has been copied to your clipboard",copyFailed:"Failed to copy the event to the clipboard\n",copyFlash:"clipboard.swf",copyUnavailable:"The clipboard is unavailable, please copy the event details from below:\n"};this._sites={google:{display:"Google",icon:0,override:null,url:"http://www.google.com/calendar/event?action=TEMPLATE"+"&text={t}&dates={s}/{e}&details={d}&location={l}&sprop=website:{u}"},icalendar:{display:"iCalendar",icon:1,override:null,url:"echo"},outlook:{display:"Outlook",icon:2,override:null,url:"echo"},yahoo:{display:"Yahoo",icon:3,override:p,url:"http://calendar.yahoo.com/?v=60&view=d&type=20"+"&title={t}&st={s}&dur={p}&desc={d}&in_loc={l}&url={u}&rpat={r}"}}}function h(t,n){e.extend(t,n);for(var r in n){if(n[r]==null){t[r]=null}}return t}function p(e,t){var n=function(e){return(e<10?"0":"")+e};var r=t.end?(t.end.getTime()-t.start.getTime())/6e4:0;e.p=r?n(Math.floor(r/60))+""+n(r%60):"";if(e.r){var i=t.recurrence.by&&t.recurrence.by[0].type=="day"?t.recurrence.by[0].values.join("").toLowerCase():"";var s={daily:"dy",weekly:"wk",monthly:"mh",yearly:"yr"}[t.recurrence.freq];e.r=i||s?n(t.recurrence.interval||1)+(i||s):""}}function d(t){var n=function(e){var t="";while(e.length>75){t+=e.substr(0,75)+"\n";e=" "+e.substr(75)}t+=e;return t};return"BEGIN:VCALENDAR\n"+"VERSION:2.0\n"+"PRODID:jquery.icalendar\n"+"METHOD:PUBLISH\n"+"BEGIN:VEVENT\n"+"UID:"+(new Date).getTime()+"@"+(window.location.href.replace(/^[^\/]*\/\/([^\/]*)\/.*$/,"$1")||"localhost")+"\n"+"DTSTAMP:"+e.icalendar.formatDateTime(new Date)+"\n"+(t.url?n("URL:"+t.url)+"\n":"")+(t.contact?n("MAILTO:"+t.contact)+"\n":"")+n("TITLE:"+t.title)+"\n"+"DTSTART:"+e.icalendar.formatDateTime(t.start)+"\n"+"DTEND:"+e.icalendar.formatDateTime(t.end)+"\n"+(t.summary?n("SUMMARY:"+t.summary)+"\n":"")+(t.description?n("DESCRIPTION:"+t.description)+"\n":"")+(t.location?n("LOCATION:"+t.location)+"\n":"")+(t.recurrence?v(t.recurrence)+"\n":"")+"END:VEVENT\n"+"END:VCALENDAR"}function v(t){if(!t){return""}var n="";if(t.dates){n="RDATE;VALUE=DATE:";if(!j(t.dates)){t.dates=[t.dates]}for(var r=0;r<t.dates.length;r++){n+=(r>0?",":"")+e.icalendar.formatDate(t.dates[r])}}else if(t.times){n="RDATE;VALUE=DATE-TIME:";if(!j(t.times)){t.times=[t.times]}for(var r=0;r<t.times.length;r++){n+=(r>0?",":"")+e.icalendar.formatDateTime(t.times[r])}}else if(t.periods){n="RDATE;VALUE=PERIOD:";if(!j(t.periods[0])){t.periods=[t.periods]}for(var r=0;r<t.periods.length;r++){n+=(r>0?",":"")+e.icalendar.formatDateTime(t.periods[r][0])+"/"+(t.periods[r][1].constructor!=Date?t.periods[r][1]:e.icalendar.formatDateTime(t.periods[r][1]))}}else{n="RRULE:FREQ="+(t.freq||"daily").toUpperCase()+(t.interval?";INTERVAL="+t.interval:"")+(t.until?";UNTIL="+e.icalendar.formatDateTime(t.until):t.count?";COUNT="+t.count:"")+(t.weekStart!=null?";WKST="+["SU","MO","TU","WE","TH","FR","SA"][t.weekStart]:"");if(t.by){if(!j(t.by)){t.by=[t.by]}for(var r=0;r<t.by.length;r++){if(!j(t.by[r].values)){t.by[r].values=[t.by[r].values]}n+=";BY"+t.by[r].type.toUpperCase()+"="+t.by[r].values.join(",")}}}return n}function m(t,r){e("#"+n).remove();try{e("body").append('<div id="'+n+'"><embed src="'+r+'" FlashVars="clipboard='+encodeURIComponent(t)+'" width="0" height="0" type="application/x-shockwave-flash"></embed></div>');return""}catch(i){return i}}function k(t){var n=t.replace(/\r\n/g,"\n").split("\n");for(var r=n.length-1;r>0;r--){var i=g.exec(n[r]);if(i){n[r-1]+=i[1];n[r]=""}}return e.map(n,function(e,t){return e?e:null})}function L(e,t,n,r){if(t>=e.length||e[t].indexOf("BEGIN:")!=0){throw"Missing group start"}var i={};var s=e[t].substr(6);O(n,s.toLowerCase(),i);t++;while(t<e.length&&e[t].indexOf("END:")!=0){if(e[t].indexOf("BEGIN:")==0){t=L(e,t,i,r)}else{var o=M(e[t]);O(i,o._name,o._simple?o._value:o)}t++}if(s=="VTIMEZONE"){var u=T.exec(i.standard.tzoffsetto);if(u){r[i.tzid]=(u[1]=="-"?-1:+1)*(parseInt(u[2],10)*60+parseInt(u[3],10))}}else{for(var a in i){A(i[a],r)}}if(e[t]!="END:"+s){throw"Missing group end "+s}return t}function A(e,t){if(!e){return}if(e.tzid&&e._value){var n=t[e.tzid];var r=function(e,t){e.setMinutes(e.getMinutes()-n);e._type=t};if(j(e._value)){for(var i=0;i<e._value.length;i++){r(e._value[i],e.tzid)}}else if(e._value.start&&e._value.end){r(e._value.start,e.tzid);r(e._value.end,e.tzid)}else{r(e._value,e.tzid)}}else if(j(e)){for(var i=0;i<e.length;i++){A(e[i],t)}}}function O(t,n,r){if(typeof r=="string"){r=r.replace(/\\n/g,"\n")}if(e.inArray(n,C)>-1){n+="_"}if(t[n]){if(!j(t[n])||t["_"+n+"IsArray"]){t[n]=[t[n]]}t[n][t[n].length]=r;if(t["_"+n+"IsArray"]){t["_"+n+"IsArray"]=undefined}}else{t[n]=r;if(j(r)){t["_"+n+"IsArray"]=true}}}function M(e){var t={};var n=y.exec(e);if(!n){throw"Missing entry name: "+e}t._name=n[1].toLowerCase();t._value=D(n[3]);t._simple=true;_(t,n[2]);return t}function _(e,t){var n=b.exec(t);while(n){var r=[];var i=w.exec(n[2]);while(i){r.push(D(i[1].replace(/^"(.*)"$/,"$1")));i=w.exec(n[2])}e[n[1].toLowerCase()]=r.length>1?r:r[0];e._simple=false;n=b.exec(t)}}function D(e){var t=S.exec(e);if(t){return P(t)}t=x.exec(e);if(t){return{start:P(t),end:P(t.slice(7))}}t=E.exec(e);if(t){return P(t.concat([0,0,0,""]))}return e}function P(e){var t=new Date(e[1],e[2]-1,e[3],e[4],e[5],e[6]);t._type=e[7]?"UTC":"float";return H(t)}function H(e){e.setMinutes(e.getMinutes()-e.getTimezoneOffset());return e}function B(e,t){t=t||t==0?t:1;var n=new Date(e.getFullYear(),e.getMonth(),e.getDate(),e.getTimezoneOffset()/-60);var r=new Date(n.getFullYear(),1-1,4);var s=r.getDay();r.setDate(4+t-s-(t>s?7:0));if(n<r){n.setDate(n.getDate()-3);return B(n,t)}else if(n>new Date(n.getFullYear(),12-1,28)){var o=new Date(n.getFullYear()+1,1-1,4);s=o.getDay();o.setDate(4+t-s-(t>s?7:0));if(n>=o){return 1}}return Math.floor((n-r)/(i[a].factor*1e3)/7)+1}function j(e){return e&&e.constructor==Array}var t="icalendar";var n="icalendar-flash-copy";var i=[{method:"Seconds",factor:1},{method:"Minutes",factor:60},{method:"Hours",factor:3600},{method:"Date",factor:86400},{method:"Month",factor:1},{method:"FullYear",factor:12},{method:"Date",factor:604800}];var s=0;var o=1;var u=2;var a=3;var f=4;var l=5;var c=6;e.extend(r.prototype,{markerClassName:"hasICalendar",setDefaults:function(e){h(this._defaults,e||{});return this},addSite:function(e,t,n,r,i){this._sites[e]={display:t,icon:n,override:i,url:r};return this},getSites:function(){return this._sites},_attachICalendar:function(t,n){t=e(t);if(t.hasClass(this.markerClassName)){return}t.addClass(this.markerClassName);this._updateICalendar(t,n)},_changeICalendar:function(t,n){t=e(t);if(!t.hasClass(this.markerClassName)){return}this._updateICalendar(t,n)},_updateICalendar:function(n,r){r=h(e.extend({},this._defaults,e.data(n[0],t)||{}),r);e.data(n[0],t,r);var i=r.sites||this._defaults.sites;if(i.length==0){e.each(this._sites,function(e){i[i.length]=e})}var s=function(t,i){var s={t:encodeURIComponent(r.title),d:encodeURIComponent(r.description),s:e.icalendar.formatDateTime(r.start),e:e.icalendar.formatDateTime(r.end),p:e.icalendar.calculateDuration(r.start,r.end),l:encodeURIComponent(r.location),u:encodeURIComponent(r.url),c:encodeURIComponent(r.contact),r:v(r.recurrence)};if(t.override){t.override.apply(n,[s,r])}var o=t.url;e.each(s,function(e,t){var n=new RegExp("\\{"+e+"\\}","g");o=o.replace(n,t)});var o=t.url=="echo"?"#":o;var u=e("<li></li>");var a=e('<a href="'+o+'" title="'+r.tipPrefix+t.display+'"'+(t.url=="echo"?"":' target="'+r._target+'"')+"></a>");if(t.url=="echo"){a.click(function(){return e.icalendar._echo(n[0],i)})}var f="";if(t.icon!=null){if(typeof t.icon=="number"){f+='<span style="background: '+"transparent url("+r.icons+") no-repeat -"+t.icon*r.iconSize+"px 0px;"+(e.browser.mozilla&&e.browser.version<"1.9"?" padding-left: "+r.iconSize+"px; padding-bottom: "+Math.max(0,r.iconSize/2-5)+"px;":"")+'"></span>'}else{f+='<img src="'+t.icon+'"'+(e.browser.mozilla&&e.browser.version<"1.9"||e.browser.msie&&e.browser.version<"7.0"?' style="vertical-align: bottom;"':e.browser.msie?' style="vertical-align: middle;"':e.browser.opera||e.browser.safari?' style="vertical-align: baseline;"':"")+"/>"}f+=r.compact?"":"&#xa0;"}a.html(f+(r.compact?"":t.display));u.append(a);return u};var o=e('<ul class="icalendar_list'+(r.compact?" icalendar_compact":"")+'"></ul>');var u=this._sites;e.each(i,function(e,t){o.append(s(u[t],t))});n.empty().append(o);if(r.popup){o.before('<span class="icalendar_popup_text">'+r.popupText+"</span>").wrap('<div class="icalendar_popup"></div>');n.click(function(){var t=e(this);var n=t.offset();e(".icalendar_popup",t).css("left",n.left).css("top",n.top+t.outerHeight()).toggle()})}},_destroyICalendar:function(n){n=e(n);if(!n.hasClass(this.markerClassName)){return}n.removeClass(this.markerClassName).empty();e.removeData(n[0],t)},_echo:function(n,r){var i=e.data(n,t);var s=d(i);if(i.echoUrl){window.location.href=i.echoUrl+"?content="+escape(s)}else if(i.echoField){e(i.echoField).val(s)}else if(!i.copyFlash){alert(i.copyUnavailable+s)}else if(confirm(i.copyConfirm)){var o="";if(o=m(s,i.copyFlash)){alert(i.copyFailed+o)}else{alert(i.copySucceeded)}}return false},_ensureTwo:function(e){return(e<10?"0":"")+e},formatDate:function(e,t){return!e?"":""+e.getFullYear()+this._ensureTwo(e.getMonth()+1)+this._ensureTwo(e.getDate())},formatDateTime:function(e,t){return!e?"":t?""+e.getFullYear()+this._ensureTwo(e.getMonth()+1)+this._ensureTwo(e.getDate())+"T"+this._ensureTwo(e.getHours())+this._ensureTwo(e.getMinutes())+this._ensureTwo(e.getSeconds()):""+e.getUTCFullYear()+this._ensureTwo(e.getUTCMonth()+1)+this._ensureTwo(e.getUTCDate())+"T"+this._ensureTwo(e.getUTCHours())+this._ensureTwo(e.getUTCMinutes())+this._ensureTwo(e.getUTCSeconds())+"Z"},calculateDuration:function(e,t){if(!e||!t){return""}var n=Math.abs(t.getTime()-e.getTime())/1e3;var r=Math.floor(n/86400);n-=r*86400;var i=Math.floor(n/3600);n-=i*3600;var s=Math.floor(n/60);n-=s*60;return(e.getTime()>t.getTime()?"-":"")+"P"+(r>0?r+"D":"")+(i||s||n?"T"+i+"H":"")+(s||n?s+"M":"")+(n?n+"S":"")},addDuration:function(e,t){if(!t){return e}var n=new Date(e.getTime());var r=N.exec(t);if(!r){throw"Invalid duration"}if(r[2]&&(r[3]||r[5]||r[6]||r[7])){throw"Invalid duration - week must be on its own"}if(!r[4]&&(r[5]||r[6]||r[7])){throw"Invalid duration - missing time marker"}var i=r[1]=="-"?-1:+1;var s=function(e,t,r){e=parseInt(e);if(!isNaN(e)){n["setUTC"+r](n["getUTC"+r]()+i*e*t)}};if(r[2]){s(r[2],7,"Date")}else{s(r[3],1,"Date");s(r[5],1,"Hours");s(r[6],1,"Minutes");s(r[7],1,"Seconds")}return n},parse:function(e){var t={};var n={};var r=k(e);L(r,0,t,n);if(!t.vcalendar){throw"Invalid iCalendar data"}return t.vcalendar},getWeekOfYear:function(e,t){return B(e,t)},_parseParams:function(e,t){return _(e,t)}});e.fn.icalendar=function(t){var n=Array.prototype.slice.call(arguments,1);return this.each(function(){if(typeof t=="string"){e.icalendar["_"+t+"ICalendar"].apply(e.icalendar,[this].concat(n))}else{e.icalendar._attachICalendar(this,t||{})}})};e.icalendar=new r;var g=/^\s(.*)$/;var y=/^([A-Za-z0-9-]+)((?:;[A-Za-z0-9-]+=(?:"[^"]+"|[^";:,]+)(?:,(?:"[^"]+"|[^";:,]+))*)*):(.*)$/;var b=/;([A-Za-z0-9-]+)=((?:"[^"]+"|[^";:,]+)(?:,(?:"[^"]+"|[^";:,]+))*)/g;var w=/,?("[^"]+"|[^";:,]+)/g;var E=/^(\d{4})(\d\d)(\d\d)$/;var S=/^(\d{4})(\d\d)(\d\d)T(\d\d)(\d\d)(\d\d)(Z?)$/;var x=/^(\d{4})(\d\d)(\d\d)T(\d\d)(\d\d)(\d\d)(Z?)\/(\d{4})(\d\d)(\d\d)T(\d\d)(\d\d)(\d\d)(Z?)$/;var T=/^([+-])(\d\d)(\d\d)$/;var N=/^([+-])?P(\d+W)?(\d+D)?(T)?(\d+H)?(\d+M)?(\d+S)?$/;var C=["class"]})(jQuery)